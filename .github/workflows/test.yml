name: Terragrunt CI Pipeline

on:
  push:
    branches: [ dev,main ]
  pull_request:
    branches: [ dev,main ]

env:
  TERRAFORM_VERSION: '1.8.4'
  TERRAGRUNT_VERSION: '0.58.5'

jobs:
  validation:
    name: Validate Terragrunt Configuration
    runs-on: ubuntu-latest
    # if: github.event_name == 'pull_request' && github.base_ref == 'refs/heads/dev'

    steps:
    - name: Debug GitHub Context
      run: |
        echo "Event: ${{ github.event_name }}"
        echo "Ref: ${{ github.ref }}"
        echo "Base Ref: ${{ github.base_ref }}"
        echo "Head Ref: ${{ github.head_ref }}"
        echo "Ref Name: ${{ github.ref_name }}"
        echo "Ref Type: ${{ github.ref_type }}"
        echo "SHA: ${{ github.sha }}"
        echo "Workflow: ${{ github.workflow }}"
        echo "Action: ${{ github.action }}"
        echo "Actor: ${{ github.actor }}"

    - name: Check PR code
      uses: actions/checkout@v4.1.1
      with:
        ref:  ${{ github.base_ref }}

    - name: Setup Terraform & Terragrunt
      uses: hashicorp/setup-terraform@v3
      with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terragrunt_version: ${{ env.TERRAGRUNT_VERSION }}

    - name: Check versions
      run:  |
        echo "Terraform version:"
        terraform version
        echo "Terragrunt version:"
        terragrunt --version